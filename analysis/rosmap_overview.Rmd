---
title: Examine methylation and H3K27ac fine-mapping results from the ROSMAP data
author: William Denault, Hao Sun, Angjing Liu, Peter Carbonetto, Gao Wang
output: workflowr::wflow_html
---

ADD SOME TEXT HERE GIVING AN OVERVIEW OF THIS ANALYSIS.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

**Note:** If you would like to run this analysis on your computer, you
will first need to download the fine-mapping outputs. They can be
downloaded from [here][box-download-link]. Once you have downloaded
the files, copy them to the "outputs" subdirectory.

Load some packges used in the code below:

```{r load-pkgs, message=FALSE}
library(data.table)
library(ggplot2)
library(cowplot)
```

## Methylation fine-mapping

First I define a helper function for loading the enrichment results:

```{r read-enrichment-results}
# The "n" argument specifies the number of "meta data" columns.
# Columns after that are treated as the enrichment results. These
# columns contain only binary data (0 or 1) indicating whether or not
# the genomic feature (genetic variant or molecular trait location)
# is assigned that specific annotation.
read_enrichment_results <- function (filename, n) {
  out <- fread(filename,sep = "\t",stringsAsFactors = FALSE,header = TRUE)
  class(out) <- "data.frame"
  out <- transform(out,chr = factor(chr))
  cols <- seq(n + 1,ncol(out))
  for (i in cols)
    out[[i]] <- factor(out[[i]])
  return(out)
}
```

Next I load methylation SNP results generated by SuSiE-topPC and fSuSiE:

```{r read-methyl-snp-results}
methyl_snps_susie_file <-
  "../outputs/ROSMAP_mQTL_cs_snp_toppc1_annotation.tsv.gz"
methyl_snps_fsusie_file <- "../outputs/ROSMAP_mQTL_cs_snp_annotation.tsv.gz"
methyl_snps_susie  <- read_enrichment_results(methyl_snps_susie_file,n = 6)
methyl_snps_fsusie <- read_enrichment_results(methyl_snps_fsusie_file,n = 7)
methyl_snps_susie$region <-
  sapply(strsplit(methyl_snps_susie$cs,":",fixed = TRUE),"[[",2)
methyl_snps_susie  <- transform(methyl_snps_susie,
                                region = factor(region),
                                cs     = factor(cs),
			  				    pc     = factor(pc))
methyl_snps_fsusie <- transform(methyl_snps_fsusie,
                                cs     = factor(cs),
								region = factor(region),
								study  = factor(study))
```

This is the number of fine-mapping regions (TADs) that contained at
least one CS in each of the analyses:

```{r methyl-tad-counts}
nlevels(methyl_snps_susie$region)
nlevels(methyl_snps_fsusie$region)
```

This is a function we will use below to get the sizes of the TADs
(in Mb):

```{r get-tad-sizes}
get_tad_sizes <- function (tads) {
  tads <- strsplit(tads,"_",fixed = TRUE)
  pos0 <- as.numeric(sapply(tads,"[[",2))
  pos1 <- as.numeric(sapply(tads,"[[",3))
  return((pos1 - pos0)/1e6)
}
```

This plot summarizes the sizes of the TADs that were analyzed by
SuSiE-topPC and fSuSiE:

```{r plot-methyl-tad-sizes, fig.height=2.75, fig.width=2.75, warning=FALSE}
plot_tad_sizes <- function (tads) {
  tad_size <- get_tad_sizes(tads)
  pdat <- data.frame(tad_size = tad_size)
  return(ggplot(pdat,aes(x = tad_size)) +
         geom_histogram(color = "white",fill = "darkblue",bins = 48) +
         labs(x = "size (Mb)",y = "number of TADs") +
         theme_cowplot(font_size = 10))
}
tads <- levels(methyl_snps_fsusie$region)
plot_tad_sizes(tads) +
  scale_x_continuous(limits = c(2,9),breaks = 1:10) +
  scale_y_continuous(breaks = seq(0,100,10))
```

Some more useful statistics on the TAD sizes:

```{r summarize-methyl-tad-sizes}
tad_size <- get_tad_sizes(tads)
range(tad_size)
mean(tad_size)
median(tad_size)
sum(tad_size > 9)
```

These histograms summarize the number of CSs per TAD:

```{r num-cs-per-tad-methyl, fig.height=2, fig.width=5, warning=FALSE}
get_cs_vs_tad_size <- function (dat) {
  tads <- levels(dat$region)
  out <- data.frame(tad      = tads,
                    tad_size = get_tad_sizes(tads),
                    num_cs   = tapply(dat$cs,dat$region,
					                  function (x) length(unique(x))))
  rownames(out) <- NULL
  return(out)
}
pdat1 <- get_cs_vs_tad_size(methyl_snps_susie)
pdat2 <- get_cs_vs_tad_size(methyl_snps_fsusie)
pdat1 <- transform(pdat1,num_cs = factor(num_cs,1:16))
pdat2 <- transform(pdat2,num_cs = factor(num_cs,1:20))
p1 <- ggplot(pdat1,aes(x = num_cs)) +
  geom_histogram(stat = "count",color = "white",fill = "darkblue") +
  scale_x_discrete(drop = FALSE) +
  labs(x = "number of CSs",y = "number of TADs",title = "SuSiE-topPC") +
  theme_cowplot(font_size = 10) +
  theme(plot.title = element_text(size = 10,face = "plain"))
p2 <- ggplot(pdat2,aes(x = num_cs)) +
  geom_histogram(stat = "count",color = "white",fill = "darkblue") +
  scale_x_discrete(drop = FALSE) +
  labs(x = "number of CSs",y = "number of TADs",title = "fSuSiE") +
  theme_cowplot(font_size = 10) +
  theme(plot.title = element_text(size = 10,face = "plain"))
plot_grid(p1,p2,nrow = 1,ncol = 2)
```

Compare discovery of causal SNPs (number of CSs) in the SuSiE-topPC
and fSuSiE analyses:

```{r compare-num-cs-per-tad-methyl, fig.height=2.75, fig.width=3.75, warning=FALSE}
dat1 <- get_cs_vs_tad_size(methyl_snps_susie)
dat2 <- get_cs_vs_tad_size(methyl_snps_fsusie)
dat1 <- dat1[c(1,3)]
dat2 <- dat2[c(1,3)]
names(dat1) <- c("tad","num_cs_susie")
names(dat2) <- c("tad","num_cs_fsusie")
dat <- merge(dat1,dat2,all = TRUE)
rows <- which(is.na(dat$num_cs_susie))
dat[rows,"num_cs_susie"] <- 0
pdat <- melt(with(dat,table(num_cs_susie,num_cs_fsusie)))
rows <- which(pdat$value == 0)
pdat[rows,"value"] <- NA
ggplot(pdat,aes(x = num_cs_susie,y = num_cs_fsusie,size = value)) +
  geom_point(color = "white",fill = "darkblue",shape = 21) +
  geom_abline(intercept = 0,slope = 1,color = "black",linetype = "dotted") +
  scale_x_continuous(breaks = seq(0,20,2),limits = c(0,20)) +
  scale_y_continuous(breaks = seq(0,20,2),limits = c(0,20)) +
  scale_size(breaks = c(1,10,100)) +
  labs(x = "SuSiE-topPC",y = "fSuSiE",size = "number of TADs") +
  theme_cowplot(font_size = 10)
```

Compare the sizes of the CSs in the SuSiE-topPC and fSuSiE analyses:

```{r cs-sizes-methyl, fig.height=2, fig.width=4, warning=FALSE}
bins <- c(0,1,2,5,10,20,Inf)
cs_size_susie  <- as.numeric(table(methyl_snps_susie$cs))
cs_size_fsusie <- as.numeric(table(methyl_snps_fsusie$cs))
cs_size_susie  <- cut(cs_size_susie,bins)
cs_size_fsusie <- cut(cs_size_fsusie,bins)
levels(cs_size_susie) <- bins[-1]
levels(cs_size_fsusie) <- bins[-1]
p1 <- ggplot(data.frame(cs_size = cs_size_susie),aes(x = cs_size)) +
  geom_histogram(stat = "count",color = "white",fill = "darkblue",
                 width = 0.65) +
  labs(x = "CS size",y = "number of CSs",title = "SuSiE-topPC") +
  theme_cowplot(font_size = 10) +
  theme(plot.title = element_text(size = 10,face = "plain"))
p2 <- ggplot(data.frame(cs_size = cs_size_fsusie),aes(x = cs_size)) +
  geom_histogram(stat = "count",color = "white",fill = "darkblue",
                 width = 0.65) +
  labs(x = "CS size",y = "number of CSs",title = "fSuSiE") +
  theme_cowplot(font_size = 10) +
  theme(plot.title = element_text(size = 10,face = "plain"))
plot_grid(p1,p2,nrow = 1,ncol = 2)
```

## H3K27ac fine-mapping

Load the H3K27ac SNP results generated by SuSiE-topPC and fSuSiE:

```{r read-ha-snp-results}
ha_snps_susie_file <- "../outputs/ROSMAP_haQTL_cs_snp_toppc1_annotation.tsv.gz"
ha_snps_fsusie_file <- "../outputs/ROSMAP_haQTL_cs_snp_annotation.tsv.gz"
ha_snps_susie  <- read_enrichment_results(ha_snps_susie_file,n = 6)
ha_snps_fsusie <- read_enrichment_results(ha_snps_fsusie_file,n = 7)
ha_snps_susie$region <-
  sapply(strsplit(ha_snps_susie$cs,":",fixed = TRUE),"[[",2)
ha_snps_susie  <- transform(ha_snps_susie,
                            region = factor(region),
                            cs     = factor(cs),
			  			    pc     = factor(pc))
ha_snps_fsusie <- transform(ha_snps_fsusie,
                            cs     = factor(cs),
						    region = factor(region),
						    study  = factor(study))
```

[box-download-link]: https://uchicago.box.com/s/tt1vgg7vqayfthg0vsbl8gw0sdi0f1uo
